# Get the array of siblings for a taxon
# Results are limited to 10k
name: ncbi_taxon_get_siblings
params:
  type: object
  required: [key]
  properties:
    key:
      type: string
      title: Document key
      description: Key of the taxon vertex for which you want to find siblings
    limit:
      type: integer
      default: 20
      description: Maximum result limit
      maximum: 1000
    offset:
      type: integer
      default: 0
      description: Result offset for pagination
      maximum: 100000
query: |
  let tax_id = CONCAT('ncbi_taxon/', @key)
  // First fetch the ID of the parent document
  let parent_id = first(
    for t in ncbi_taxon
      filter t._key == @key
      for parent in 1..1 outbound t ncbi_child_of_taxon
        limit 1
        return parent._id
  )
  // Then find the child IDs through the edge fields
  let child_ids = (
    for e in ncbi_child_of_taxon
      filter e._to == parent_id AND e._from != tax_id
      return e._from
  )
  // Sort and filter the children
  let sorted = (
    for tax in ncbi_taxon
      filter tax._id in child_ids
      sort tax.scientific_name asc
      limit @offset, @limit
      return tax
  )
  return {total_count: COUNT(child_ids), results: sorted}
